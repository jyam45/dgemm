#include "myblas_internal.h"

void myblas_dgemm_copy_n_detail(size_t K, size_t N, const double* B, size_t k, size_t j,  size_t ldb, double* B2 ){

	double x00,x01,x02,x03;
	double x10,x11,x12,x13;
	double x20,x21,x22,x23;
	double x30,x31,x32,x33;

	B = B + k + ldb*j; // start point

	if( N >> 2 ){
	  size_t n4 = ( N >> 2 );
	  while( n4-- ){

	    if( K >> 3 ){
	      size_t k8 = ( K >> 3 );
	      while( k8-- ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb); x20 = *(B+2+0*ldb); x30 = *(B+3+0*ldb);
	          x01 = *(B+0+1*ldb); x11 = *(B+1+1*ldb); x21 = *(B+2+1*ldb); x31 = *(B+3+1*ldb);
	          x02 = *(B+0+2*ldb); x12 = *(B+1+2*ldb); x22 = *(B+2+2*ldb); x32 = *(B+3+2*ldb);
	          x03 = *(B+0+3*ldb); x13 = *(B+1+3*ldb); x23 = *(B+2+3*ldb); x33 = *(B+3+3*ldb);
	          *(B2+0*4+0) = x00; *(B2+1*4+0) = x10; *(B2+2*4+0) = x20; *(B2+3*4+0) = x30;
	          *(B2+0*4+1) = x01; *(B2+1*4+1) = x11; *(B2+2*4+1) = x21; *(B2+3*4+1) = x31;
	          *(B2+0*4+2) = x02; *(B2+1*4+2) = x12; *(B2+2*4+2) = x22; *(B2+3*4+2) = x32;
	          *(B2+0*4+3) = x03; *(B2+1*4+3) = x13; *(B2+2*4+3) = x23; *(B2+3*4+3) = x33;
	          x00 = *(B+4+0*ldb); x10 = *(B+5+0*ldb); x20 = *(B+6+0*ldb); x30 = *(B+7+0*ldb);
	          x01 = *(B+4+1*ldb); x11 = *(B+5+1*ldb); x21 = *(B+6+1*ldb); x31 = *(B+7+1*ldb);
	          x02 = *(B+4+2*ldb); x12 = *(B+5+2*ldb); x22 = *(B+6+2*ldb); x32 = *(B+7+2*ldb);
	          x03 = *(B+4+3*ldb); x13 = *(B+5+3*ldb); x23 = *(B+6+3*ldb); x33 = *(B+7+3*ldb);
	          *(B2+4*4+0) = x00; *(B2+5*4+0) = x10; *(B2+6*4+0) = x20; *(B2+7*4+0) = x30;
	          *(B2+4*4+1) = x01; *(B2+5*4+1) = x11; *(B2+6*4+1) = x21; *(B2+7*4+1) = x31;
	          *(B2+4*4+2) = x02; *(B2+5*4+2) = x12; *(B2+6*4+2) = x22; *(B2+7*4+2) = x32;
	          *(B2+4*4+3) = x03; *(B2+5*4+3) = x13; *(B2+6*4+3) = x23; *(B2+7*4+3) = x33;
	          B+=8;
	          B2+=32;
	      }
	    }
	    if( K & 4  ){
	    //if( K >> 2 ){
	    //  size_t k4 = ( K >> 2 ); // unrolling with 8 elements
	    //  while( k4-- ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb); x20 = *(B+2+0*ldb); x30 = *(B+3+0*ldb);
	          x01 = *(B+0+1*ldb); x11 = *(B+1+1*ldb); x21 = *(B+2+1*ldb); x31 = *(B+3+1*ldb);
	          x02 = *(B+0+2*ldb); x12 = *(B+1+2*ldb); x22 = *(B+2+2*ldb); x32 = *(B+3+2*ldb);
	          x03 = *(B+0+3*ldb); x13 = *(B+1+3*ldb); x23 = *(B+2+3*ldb); x33 = *(B+3+3*ldb);
	          *(B2+0*4+0) = x00; *(B2+1*4+0) = x10; *(B2+2*4+0) = x20; *(B2+3*4+0) = x30;
	          *(B2+0*4+1) = x01; *(B2+1*4+1) = x11; *(B2+2*4+1) = x21; *(B2+3*4+1) = x31;
	          *(B2+0*4+2) = x02; *(B2+1*4+2) = x12; *(B2+2*4+2) = x22; *(B2+3*4+2) = x32;
	          *(B2+0*4+3) = x03; *(B2+1*4+3) = x13; *(B2+2*4+3) = x23; *(B2+3*4+3) = x33;
	          B+=4;
	          B2+=16;
	    //  }
	    }
	    if( K & 2 ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb);
	          x01 = *(B+0+1*ldb); x11 = *(B+1+1*ldb);
	          x02 = *(B+0+2*ldb); x12 = *(B+1+2*ldb);
	          x03 = *(B+0+3*ldb); x13 = *(B+1+3*ldb);
	          *(B2+0*4+0) = x00; *(B2+1*4+0) = x10;
	          *(B2+0*4+1) = x01; *(B2+1*4+1) = x11;
	          *(B2+0*4+2) = x02; *(B2+1*4+2) = x12;
	          *(B2+0*4+3) = x03; *(B2+1*4+3) = x13;
	          B+=2;
	          B2+=8;
	    }
	    if( K & 1 ){
	          x00 = *(B+0+0*ldb);
	          x01 = *(B+0+1*ldb);
	          x02 = *(B+0+2*ldb);
	          x03 = *(B+0+3*ldb);
	          *(B2+0*4+0) = x00;
	          *(B2+0*4+1) = x01;
	          *(B2+0*4+2) = x02;
	          *(B2+0*4+3) = x03;
	          B+=1;
	          B2+=4;
	    }
	    B  = B  - K + 4*ldb ;

	  }
	}
	if( N & 2 ){

	    if( K >> 3 ){
	      size_t k8 = ( K >> 3 );
	      while( k8-- ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb); x20 = *(B+2+0*ldb); x30 = *(B+3+0*ldb);
	          x01 = *(B+0+1*ldb); x11 = *(B+1+1*ldb); x21 = *(B+2+1*ldb); x31 = *(B+3+1*ldb);
	          *(B2+0*2+0) = x00; *(B2+1*2+0) = x10; *(B2+2*2+0) = x20; *(B2+3*2+0) = x30;
	          *(B2+0*2+1) = x01; *(B2+1*2+1) = x11; *(B2+2*2+1) = x21; *(B2+3*2+1) = x31;
	          x00 = *(B+4+0*ldb); x10 = *(B+5+0*ldb); x20 = *(B+6+0*ldb); x30 = *(B+7+0*ldb);
	          x01 = *(B+4+1*ldb); x11 = *(B+5+1*ldb); x21 = *(B+6+1*ldb); x31 = *(B+7+1*ldb);
	          *(B2+4*2+0) = x00; *(B2+5*2+0) = x10; *(B2+6*2+0) = x20; *(B2+7*2+0) = x30;
	          *(B2+4*2+1) = x01; *(B2+5*2+1) = x11; *(B2+6*2+1) = x21; *(B2+7*2+1) = x31;
	          B+=8;
	          B2+=16;
	      }
	    }
	    if( K & 4  ){
	    //if( K >> 2 ){
	    //  size_t k4 = ( K >> 2 ); // unrolling with 8 elements
	    //  while( k4-- ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb); x20 = *(B+2+0*ldb); x30 = *(B+3+0*ldb);
	          x01 = *(B+0+1*ldb); x11 = *(B+1+1*ldb); x21 = *(B+2+1*ldb); x31 = *(B+3+1*ldb);
	          *(B2+0*2+0) = x00; *(B2+1*2+0) = x10; *(B2+2*2+0) = x20; *(B2+3*2+0) = x30;
	          *(B2+0*2+1) = x01; *(B2+1*2+1) = x11; *(B2+2*2+1) = x21; *(B2+3*2+1) = x31;
	          B+=4;
	          B2+=8;
	    //  }
	    }
	    if( K & 2 ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb);
	          x01 = *(B+0+1*ldb); x11 = *(B+1+1*ldb);
	          *(B2+0*2+0) = x00; *(B2+1*2+0) = x10;
	          *(B2+0*2+1) = x01; *(B2+1*2+1) = x11;
	          B+=2;
	          B2+=4;
	    }
	    if( K & 1 ){
	          x00 = *(B+0+0*ldb);
	          x01 = *(B+0+1*ldb);
	          *(B2+0*2+0) = x00;
	          *(B2+0*2+1) = x01;
	          B+=1;
	          B2+=2;
	    }
	    B  = B  - K + 2*ldb ;

	}
	if( N & 1 ){

	    if( K >> 3 ){
	      size_t k8 = ( K >> 3 );
	      while( k8-- ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb); x20 = *(B+2+0*ldb); x30 = *(B+3+0*ldb);
	          *(B2+0*1+0) = x00; *(B2+1*1+0) = x10; *(B2+2*1+0) = x20; *(B2+3*1+0) = x30;
	          x00 = *(B+4+0*ldb); x10 = *(B+5+0*ldb); x20 = *(B+6+0*ldb); x30 = *(B+7+0*ldb);
	          *(B2+4*1+0) = x00; *(B2+5*1+0) = x10; *(B2+6*1+0) = x20; *(B2+7*1+0) = x30;
	          B+=8;
	          B2+=8;
	      }
	    }
	    if( K & 4  ){
	    //if( K >> 2 ){
	    //  size_t k4 = ( K >> 2 ); // unrolling with 8 elements
	    //  while( k4-- ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb); x20 = *(B+2+0*ldb); x30 = *(B+3+0*ldb);
	          *(B2+0*1+0) = x00; *(B2+1*1+0) = x10; *(B2+2*1+0) = x20; *(B2+3*1+0) = x30;
	          B+=4;
	          B2+=4;
	    //  }
	    }
	    if( K & 2 ){
	          x00 = *(B+0+0*ldb); x10 = *(B+1+0*ldb);
	          *(B2+0*1+0) = x00; *(B2+1*1+0) = x10;
	          B+=2;
	          B2+=2;
	    }
	    if( K & 1 ){
	          x00 = *(B+0+0*ldb);
	          *(B2+0*1+0) = x00;
	          B+=1;
	          B2+=1;
	    }
	    B  = B  - K + ldb ;

	}


}


