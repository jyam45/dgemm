#include "myblas_internal.h"
#include <stdio.h>

void myblas_dgemm_kernel_detail(
         size_t M, size_t N, size_t K,
         double alpha, const double *A2, const double *B2, 
         double *C, size_t ldc )
{
	double a00,a01,a02,a03;
	double a10,a11,a12,a13;
	double a20,a21,a22,a23;
	double a30,a31,a32,a33;

	double b00,b01,b02,b03;
	double b10,b11,b12,b13;
	double b20,b21,b22,b23;
	double b30,b31,b32,b33;

	double c00,c01,c02,c03;
	double c10,c11,c12,c13;
	double c20,c21,c22,c23;
	double c30,c31,c32,c33;

	// Kernel ----
	
	if( N >> 1 ){
	  size_t n2 = ( N >> 1 ); // unrolling N
	  while( n2-- ){

	    
	    if( M >> 2 ){
	      size_t m4 = ( M >> 2 ); // unrolling M
	      while( m4-- ){
	        //AB=0e0;
	        c00=0e0;c01=0e0;
	        c10=0e0;c11=0e0;
	        c20=0e0;c21=0e0;
	        c30=0e0;c31=0e0;
	        
	        if( K >> 3 ){
	          size_t k8 = ( K >> 3 ); // Unrolling K
	          while( k8-- ){
	            a00 = *(A2 + 0 + 0*8 ); a10 = *(A2 + 1 + 0*8 ); a20 = *(A2 + 2 + 0*8 ); a30 = *(A2 + 3 + 0*8 ); // ymm0
	            a01 = *(A2 + 0 + 1*8 ); a11 = *(A2 + 1 + 1*8 ); a21 = *(A2 + 2 + 1*8 ); a31 = *(A2 + 3 + 1*8 ); // ymm1
	            a02 = *(A2 + 0 + 2*8 ); a12 = *(A2 + 1 + 2*8 ); a22 = *(A2 + 2 + 2*8 ); a32 = *(A2 + 3 + 2*8 ); // ymm2
	            a03 = *(A2 + 0 + 3*8 ); a13 = *(A2 + 1 + 3*8 ); a23 = *(A2 + 2 + 3*8 ); a33 = *(A2 + 3 + 3*8 ); // ymm3
	            b00 = *(B2 + 0 + 0*8 ); b10 = *(B2 + 1 + 0*8 ); b20 = *(B2 + 2 + 0*8 ); b30 = *(B2 + 3 + 0*8 ); // ymm4
	            b01 = *(B2 + 0 + 1*8 ); b11 = *(B2 + 1 + 1*8 ); b21 = *(B2 + 2 + 1*8 ); b31 = *(B2 + 3 + 1*8 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c11 += a01 * b01; c11 += a11 * b11; c11 += a21 * b21; c11 += a31 * b31; // ymm13
	            c20 += a02 * b00; c20 += a12 * b10; c20 += a22 * b20; c20 += a32 * b30; // ymm12
	            c21 += a02 * b01; c21 += a12 * b11; c21 += a22 * b21; c21 += a32 * b31; // ymm13
	            c30 += a03 * b00; c30 += a13 * b10; c30 += a23 * b20; c30 += a33 * b30; // ymm12
	            c31 += a03 * b01; c31 += a13 * b11; c31 += a23 * b21; c31 += a33 * b31; // ymm13
	            a00 = *(A2 + 4 + 0*8 ); a10 = *(A2 + 5 + 0*8 ); a20 = *(A2 + 6 + 0*8 ); a30 = *(A2 + 7 + 0*8 ); // ymm0
	            a01 = *(A2 + 4 + 1*8 ); a11 = *(A2 + 5 + 1*8 ); a21 = *(A2 + 6 + 1*8 ); a31 = *(A2 + 7 + 1*8 ); // ymm1
	            a02 = *(A2 + 4 + 2*8 ); a12 = *(A2 + 5 + 2*8 ); a22 = *(A2 + 6 + 2*8 ); a32 = *(A2 + 7 + 2*8 ); // ymm2
	            a03 = *(A2 + 4 + 3*8 ); a13 = *(A2 + 5 + 3*8 ); a23 = *(A2 + 6 + 3*8 ); a33 = *(A2 + 7 + 3*8 ); // ymm3
	            b00 = *(B2 + 4 + 0*8 ); b10 = *(B2 + 5 + 0*8 ); b20 = *(B2 + 6 + 0*8 ); b30 = *(B2 + 7 + 0*8 ); // ymm4
	            b01 = *(B2 + 4 + 1*8 ); b11 = *(B2 + 5 + 1*8 ); b21 = *(B2 + 6 + 1*8 ); b31 = *(B2 + 7 + 1*8 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c11 += a01 * b01; c11 += a11 * b11; c11 += a21 * b21; c11 += a31 * b31; // ymm13
	            c20 += a02 * b00; c20 += a12 * b10; c20 += a22 * b20; c20 += a32 * b30; // ymm12
	            c21 += a02 * b01; c21 += a12 * b11; c21 += a22 * b21; c21 += a32 * b31; // ymm13
	            c30 += a03 * b00; c30 += a13 * b10; c30 += a23 * b20; c30 += a33 * b30; // ymm12
	            c31 += a03 * b01; c31 += a13 * b11; c31 += a23 * b21; c31 += a33 * b31; // ymm13
	            A2+=32;
	            B2+=16;
	          }
	        }
	        if( K & 4 ){
	        //if( K >> 2 ){
	        //  size_t k4 = ( K >> 2 ); // Unrolling K
	        //  while( k4-- ){
	            a00 = *(A2 + 0 + 0*4 ); a10 = *(A2 + 1 + 0*4 ); a20 = *(A2 + 2 + 0*4 ); a30 = *(A2 + 3 + 0*4 ); // ymm0
	            a01 = *(A2 + 0 + 1*4 ); a11 = *(A2 + 1 + 1*4 ); a21 = *(A2 + 2 + 1*4 ); a31 = *(A2 + 3 + 1*4 ); // ymm1
	            a02 = *(A2 + 0 + 2*4 ); a12 = *(A2 + 1 + 2*4 ); a22 = *(A2 + 2 + 2*4 ); a32 = *(A2 + 3 + 2*4 ); // ymm2
	            a03 = *(A2 + 0 + 3*4 ); a13 = *(A2 + 1 + 3*4 ); a23 = *(A2 + 2 + 3*4 ); a33 = *(A2 + 3 + 3*4 ); // ymm3
	            b00 = *(B2 + 0 + 0*4 ); b10 = *(B2 + 1 + 0*4 ); b20 = *(B2 + 2 + 0*4 ); b30 = *(B2 + 3 + 0*4 ); // ymm4
	            b01 = *(B2 + 0 + 1*4 ); b11 = *(B2 + 1 + 1*4 ); b21 = *(B2 + 2 + 1*4 ); b31 = *(B2 + 3 + 1*4 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c11 += a01 * b01; c11 += a11 * b11; c11 += a21 * b21; c11 += a31 * b31; // ymm13
	            c20 += a02 * b00; c20 += a12 * b10; c20 += a22 * b20; c20 += a32 * b30; // ymm12
	            c21 += a02 * b01; c21 += a12 * b11; c21 += a22 * b21; c21 += a32 * b31; // ymm13
	            c30 += a03 * b00; c30 += a13 * b10; c30 += a23 * b20; c30 += a33 * b30; // ymm12
	            c31 += a03 * b01; c31 += a13 * b11; c31 += a23 * b21; c31 += a33 * b31; // ymm13
	            A2+=16;
	            B2+=8;
	        //  }
	        }
	        if( K & 2 ){

	            a00 = *(A2 + 0 + 0*2 ); a10 = *(A2 + 1 + 0*2 );
	            a01 = *(A2 + 0 + 1*2 ); a11 = *(A2 + 1 + 1*2 );
	            a02 = *(A2 + 0 + 2*2 ); a12 = *(A2 + 1 + 2*2 );
	            a03 = *(A2 + 0 + 3*2 ); a13 = *(A2 + 1 + 3*2 );
	            b00 = *(B2 + 0 + 0*2 ); b10 = *(B2 + 1 + 0*2 );
	            b01 = *(B2 + 0 + 1*2 ); b11 = *(B2 + 1 + 1*2 );
	            c00 += a00 * b00; c00 += a10 * b10;
	            c01 += a00 * b01; c01 += a10 * b11;
	            c10 += a01 * b00; c10 += a11 * b10;
	            c11 += a01 * b01; c11 += a11 * b11;
	            c20 += a02 * b00; c20 += a12 * b10;
	            c21 += a02 * b01; c21 += a12 * b11;
	            c30 += a03 * b00; c30 += a13 * b10;
	            c31 += a03 * b01; c31 += a13 * b11;
	            A2+=8;
	            B2+=4;

	        }
	        if( K & 1 ){

	            a00 = *(A2 + 0 + 0*1 );
	            a01 = *(A2 + 0 + 1*1 );
	            a02 = *(A2 + 0 + 2*1 );
	            a03 = *(A2 + 0 + 3*1 );
	            b00 = *(B2 + 0 + 0*1 );
	            b01 = *(B2 + 0 + 1*1 );
	            c00 += a00 * b00;
	            c01 += a00 * b01;
	            c10 += a01 * b00;
	            c11 += a01 * b01;
	            c20 += a02 * b00;
	            c21 += a02 * b01;
	            c30 += a03 * b00;
	            c31 += a03 * b01;
	            A2+=4;
	            B2+=2;

	        }
	        *(C+0+0*ldc) += alpha*c00;
	        *(C+0+1*ldc) += alpha*c01;
	        *(C+1+0*ldc) += alpha*c10;
	        *(C+1+1*ldc) += alpha*c11;
	        *(C+2+0*ldc) += alpha*c20;
	        *(C+2+1*ldc) += alpha*c21;
	        *(C+3+0*ldc) += alpha*c30;
	        *(C+3+1*ldc) += alpha*c31;
	        //A2 = A2 - K + 4*K;
	        B2 = B2 - 2*K;
	        C+=4;
	        //printf("pass through (n&2)&(m>>2)\n");
	      }
	    }
	    if( M & 2 ){

	        c00=0e0;c01=0e0;
	        c10=0e0;c11=0e0;
	        
	        if( K >> 3 ){
	          size_t k8 = ( K >> 3 ); // Unrolling K
	          while( k8-- ){
	            a00 = *(A2 + 0 + 0*8 ); a10 = *(A2 + 1 + 0*8 ); a20 = *(A2 + 2 + 0*8 ); a30 = *(A2 + 3 + 0*8 ); // ymm0
	            a01 = *(A2 + 0 + 1*8 ); a11 = *(A2 + 1 + 1*8 ); a21 = *(A2 + 2 + 1*8 ); a31 = *(A2 + 3 + 1*8 ); // ymm1
	            b00 = *(B2 + 0 + 0*8 ); b10 = *(B2 + 1 + 0*8 ); b20 = *(B2 + 2 + 0*8 ); b30 = *(B2 + 3 + 0*8 ); // ymm4
	            b01 = *(B2 + 0 + 1*8 ); b11 = *(B2 + 1 + 1*8 ); b21 = *(B2 + 2 + 1*8 ); b31 = *(B2 + 3 + 1*8 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c11 += a01 * b01; c11 += a11 * b11; c11 += a21 * b21; c11 += a31 * b31; // ymm13
	            a00 = *(A2 + 4 + 0*8 ); a10 = *(A2 + 5 + 0*8 ); a20 = *(A2 + 6 + 0*8 ); a30 = *(A2 + 7 + 0*8 ); // ymm0
	            a01 = *(A2 + 4 + 1*8 ); a11 = *(A2 + 5 + 1*8 ); a21 = *(A2 + 6 + 1*8 ); a31 = *(A2 + 7 + 1*8 ); // ymm1
	            b00 = *(B2 + 4 + 0*8 ); b10 = *(B2 + 5 + 0*8 ); b20 = *(B2 + 6 + 0*8 ); b30 = *(B2 + 7 + 0*8 ); // ymm4
	            b01 = *(B2 + 4 + 1*8 ); b11 = *(B2 + 5 + 1*8 ); b21 = *(B2 + 6 + 1*8 ); b31 = *(B2 + 7 + 1*8 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c11 += a01 * b01; c11 += a11 * b11; c11 += a21 * b21; c11 += a31 * b31; // ymm13
	            A2+=16;
	            B2+=16;
	          }
	        }
	        if( K & 4 ){
	        //if( K >> 2 ){
	        //  size_t k4 = ( K >> 2 ); // Unrolling K
	        //  while( k4-- ){
	            a00 = *(A2 + 0 + 0*4 ); a10 = *(A2 + 1 + 0*4 ); a20 = *(A2 + 2 + 0*4 ); a30 = *(A2 + 3 + 0*4 ); // ymm0
	            a01 = *(A2 + 0 + 1*4 ); a11 = *(A2 + 1 + 1*4 ); a21 = *(A2 + 2 + 1*4 ); a31 = *(A2 + 3 + 1*4 ); // ymm1
	            b00 = *(B2 + 0 + 0*4 ); b10 = *(B2 + 1 + 0*4 ); b20 = *(B2 + 2 + 0*4 ); b30 = *(B2 + 3 + 0*4 ); // ymm4
	            b01 = *(B2 + 0 + 1*4 ); b11 = *(B2 + 1 + 1*4 ); b21 = *(B2 + 2 + 1*4 ); b31 = *(B2 + 3 + 1*4 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c11 += a01 * b01; c11 += a11 * b11; c11 += a21 * b21; c11 += a31 * b31; // ymm13
	            A2+=8;
	            B2+=8;
	        //  }
	        }
	        if( K & 2 ){

	            a00 = *(A2 + 0 + 0*2 ); a10 = *(A2 + 1 + 0*2 );
	            a01 = *(A2 + 0 + 1*2 ); a11 = *(A2 + 1 + 1*2 );
	            b00 = *(B2 + 0 + 0*2 ); b10 = *(B2 + 1 + 0*2 );
	            b01 = *(B2 + 0 + 1*2 ); b11 = *(B2 + 1 + 1*2 );
	            c00 += a00 * b00; c00 += a10 * b10;
	            c01 += a00 * b01; c01 += a10 * b11;
	            c10 += a01 * b00; c10 += a11 * b10;
	            c11 += a01 * b01; c11 += a11 * b11;
	            A2+=4;
	            B2+=4;

	        }
	        if( K & 1 ){

	            a00 = *(A2 + 0 + 0*1 );
	            a01 = *(A2 + 0 + 1*1 );
	            b00 = *(B2 + 0 + 0*1 );
	            b01 = *(B2 + 0 + 1*1 );
	            c00 += a00 * b00;
	            c01 += a00 * b01;
	            c10 += a01 * b00;
	            c11 += a01 * b01;
	            A2+=2;
	            B2+=2;

	        }
	        *(C+0+0*ldc) += alpha*c00;
	        *(C+0+1*ldc) += alpha*c01;
	        *(C+1+0*ldc) += alpha*c10;
	        *(C+1+1*ldc) += alpha*c11;
	        //A2 = A2 - K + 4*K;
	        B2 = B2 - 2*K;
	        C+=2;
	        //printf("pass through (n&2)&(m&2)\n");

	    }
	    if( M & 1 ){

	        c00=0e0;c01=0e0;
	        
	        if( K >> 3 ){
	          size_t k8 = ( K >> 3 ); // Unrolling K
	          while( k8-- ){
	            a00 = *(A2 + 0 + 0*8 ); a10 = *(A2 + 1 + 0*8 ); a20 = *(A2 + 2 + 0*8 ); a30 = *(A2 + 3 + 0*8 ); // ymm0
	            b00 = *(B2 + 0 + 0*8 ); b10 = *(B2 + 1 + 0*8 ); b20 = *(B2 + 2 + 0*8 ); b30 = *(B2 + 3 + 0*8 ); // ymm4
	            b01 = *(B2 + 0 + 1*8 ); b11 = *(B2 + 1 + 1*8 ); b21 = *(B2 + 2 + 1*8 ); b31 = *(B2 + 3 + 1*8 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            a00 = *(A2 + 4 + 0*8 ); a10 = *(A2 + 5 + 0*8 ); a20 = *(A2 + 6 + 0*8 ); a30 = *(A2 + 7 + 0*8 ); // ymm0
	            b00 = *(B2 + 4 + 0*8 ); b10 = *(B2 + 5 + 0*8 ); b20 = *(B2 + 6 + 0*8 ); b30 = *(B2 + 7 + 0*8 ); // ymm4
	            b01 = *(B2 + 4 + 1*8 ); b11 = *(B2 + 5 + 1*8 ); b21 = *(B2 + 6 + 1*8 ); b31 = *(B2 + 7 + 1*8 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            A2+=8;
	            B2+=16;
	          }
	        }
	        if( K & 4 ){
	        //if( K >> 2 ){
	        //  size_t k4 = ( K >> 2 ); // Unrolling K
	        //  while( k4-- ){
	            a00 = *(A2 + 0 + 0*4 ); a10 = *(A2 + 1 + 0*4 ); a20 = *(A2 + 2 + 0*4 ); a30 = *(A2 + 3 + 0*4 ); // ymm0
	            b00 = *(B2 + 0 + 0*4 ); b10 = *(B2 + 1 + 0*4 ); b20 = *(B2 + 2 + 0*4 ); b30 = *(B2 + 3 + 0*4 ); // ymm4
	            b01 = *(B2 + 0 + 1*4 ); b11 = *(B2 + 1 + 1*4 ); b21 = *(B2 + 2 + 1*4 ); b31 = *(B2 + 3 + 1*4 ); // ymm5
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c01 += a00 * b01; c01 += a10 * b11; c01 += a20 * b21; c01 += a30 * b31; // ymm13
	            A2+=4;
	            B2+=8;
	        //  }
	        }
	        if( K & 2 ){

	            a00 = *(A2 + 0 + 0*2 ); a10 = *(A2 + 1 + 0*2 );
	            b00 = *(B2 + 0 + 0*2 ); b10 = *(B2 + 1 + 0*2 );
	            b01 = *(B2 + 0 + 1*2 ); b11 = *(B2 + 1 + 1*2 );
	            c00 += a00 * b00; c00 += a10 * b10;
	            c01 += a00 * b01; c01 += a10 * b11;
	            A2+=2;
	            B2+=4;

	        }
	        if( K & 1 ){

	            a00 = *(A2 + 0 + 0*1 );
	            b00 = *(B2 + 0 + 0*1 );
	            b01 = *(B2 + 0 + 1*1 );
	            c00 += a00 * b00;
	            c01 += a00 * b01;
	            A2+=1;
	            B2+=2;

	        }
	        *(C+0+0*ldc) += alpha*c00;
	        *(C+0+1*ldc) += alpha*c01;
	        //A2 = A2 - K + 4*K;
	        B2 = B2 - 2*K;
	        C+=1;
	        //printf("pass through (n&2)&(m&1)\n");

	    }
	    A2 = A2 - M*K;
	    B2 = B2 + 2*K;
	    C  = C - M + 2*ldc;
	  }
	}
	if( N & 1 ){

	    
	    if( M >> 2 ){
	      size_t m4 = ( M >> 2 ); // unrolling M
	      while( m4-- ){
	        //AB=0e0;
	        c00=0e0;
	        c10=0e0;
	        c20=0e0;
	        c30=0e0;
	        
	        if( K >> 3 ){
	          size_t k8 = ( K >> 3 ); // Unrolling K
	          while( k8-- ){
	            a00 = *(A2 + 0 + 0*8 ); a10 = *(A2 + 1 + 0*8 ); a20 = *(A2 + 2 + 0*8 ); a30 = *(A2 + 3 + 0*8 ); // ymm0
	            a01 = *(A2 + 0 + 1*8 ); a11 = *(A2 + 1 + 1*8 ); a21 = *(A2 + 2 + 1*8 ); a31 = *(A2 + 3 + 1*8 ); // ymm1
	            a02 = *(A2 + 0 + 2*8 ); a12 = *(A2 + 1 + 2*8 ); a22 = *(A2 + 2 + 2*8 ); a32 = *(A2 + 3 + 2*8 ); // ymm2
	            a03 = *(A2 + 0 + 3*8 ); a13 = *(A2 + 1 + 3*8 ); a23 = *(A2 + 2 + 3*8 ); a33 = *(A2 + 3 + 3*8 ); // ymm3
	            b00 = *(B2 + 0 + 0*8 ); b10 = *(B2 + 1 + 0*8 ); b20 = *(B2 + 2 + 0*8 ); b30 = *(B2 + 3 + 0*8 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c20 += a02 * b00; c20 += a12 * b10; c20 += a22 * b20; c20 += a32 * b30; // ymm12
	            c30 += a03 * b00; c30 += a13 * b10; c30 += a23 * b20; c30 += a33 * b30; // ymm12
	            a00 = *(A2 + 4 + 0*8 ); a10 = *(A2 + 5 + 0*8 ); a20 = *(A2 + 6 + 0*8 ); a30 = *(A2 + 7 + 0*8 ); // ymm0
	            a01 = *(A2 + 4 + 1*8 ); a11 = *(A2 + 5 + 1*8 ); a21 = *(A2 + 6 + 1*8 ); a31 = *(A2 + 7 + 1*8 ); // ymm1
	            a02 = *(A2 + 4 + 2*8 ); a12 = *(A2 + 5 + 2*8 ); a22 = *(A2 + 6 + 2*8 ); a32 = *(A2 + 7 + 2*8 ); // ymm2
	            a03 = *(A2 + 4 + 3*8 ); a13 = *(A2 + 5 + 3*8 ); a23 = *(A2 + 6 + 3*8 ); a33 = *(A2 + 7 + 3*8 ); // ymm3
	            b00 = *(B2 + 4 + 0*8 ); b10 = *(B2 + 5 + 0*8 ); b20 = *(B2 + 6 + 0*8 ); b30 = *(B2 + 7 + 0*8 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c20 += a02 * b00; c20 += a12 * b10; c20 += a22 * b20; c20 += a32 * b30; // ymm12
	            c30 += a03 * b00; c30 += a13 * b10; c30 += a23 * b20; c30 += a33 * b30; // ymm12
	            A2+=32;
	            B2+=8;
	          }
	        }
	        if( K & 4 ){
	        //if( K >> 2 ){
	        //  size_t k4 = ( K >> 2 ); // Unrolling K
	        //  while( k4-- ){
	            a00 = *(A2 + 0 + 0*4 ); a10 = *(A2 + 1 + 0*4 ); a20 = *(A2 + 2 + 0*4 ); a30 = *(A2 + 3 + 0*4 ); // ymm0
	            a01 = *(A2 + 0 + 1*4 ); a11 = *(A2 + 1 + 1*4 ); a21 = *(A2 + 2 + 1*4 ); a31 = *(A2 + 3 + 1*4 ); // ymm1
	            a02 = *(A2 + 0 + 2*4 ); a12 = *(A2 + 1 + 2*4 ); a22 = *(A2 + 2 + 2*4 ); a32 = *(A2 + 3 + 2*4 ); // ymm2
	            a03 = *(A2 + 0 + 3*4 ); a13 = *(A2 + 1 + 3*4 ); a23 = *(A2 + 2 + 3*4 ); a33 = *(A2 + 3 + 3*4 ); // ymm3
	            b00 = *(B2 + 0 + 0*4 ); b10 = *(B2 + 1 + 0*4 ); b20 = *(B2 + 2 + 0*4 ); b30 = *(B2 + 3 + 0*4 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            c20 += a02 * b00; c20 += a12 * b10; c20 += a22 * b20; c20 += a32 * b30; // ymm12
	            c30 += a03 * b00; c30 += a13 * b10; c30 += a23 * b20; c30 += a33 * b30; // ymm12
	            A2+=16;
	            B2+=4;
	        //  }
	        }
	        if( K & 2 ){

	            a00 = *(A2 + 0 + 0*2 ); a10 = *(A2 + 1 + 0*2 );
	            a01 = *(A2 + 0 + 1*2 ); a11 = *(A2 + 1 + 1*2 );
	            a02 = *(A2 + 0 + 2*2 ); a12 = *(A2 + 1 + 2*2 );
	            a03 = *(A2 + 0 + 3*2 ); a13 = *(A2 + 1 + 3*2 );
	            b00 = *(B2 + 0 + 0*2 ); b10 = *(B2 + 1 + 0*2 );
	            c00 += a00 * b00; c00 += a10 * b10;
	            c10 += a01 * b00; c10 += a11 * b10;
	            c20 += a02 * b00; c20 += a12 * b10;
	            c30 += a03 * b00; c30 += a13 * b10;
	            A2+=8;
	            B2+=2;

	        }
	        if( K & 1 ){

	            a00 = *(A2 + 0 + 0*1 );
	            a01 = *(A2 + 0 + 1*1 );
	            a02 = *(A2 + 0 + 2*1 );
	            a03 = *(A2 + 0 + 3*1 );
	            b00 = *(B2 + 0 + 0*1 );
	            c00 += a00 * b00;
	            c10 += a01 * b00;
	            c20 += a02 * b00;
	            c30 += a03 * b00;
	            A2+=4;
	            B2+=1;

	        }
	        *(C+0+0*ldc) += alpha*c00;
	        *(C+1+0*ldc) += alpha*c10;
	        *(C+2+0*ldc) += alpha*c20;
	        *(C+3+0*ldc) += alpha*c30;
	        //A2 = A2 - K + 4*K;
	        B2 = B2 - 1*K;
	        C+=4;
	        //printf("pass through (n&1)&(m>>2)\n");
	      }
	    }
	    if( M & 2 ){

	        c00=0e0;
	        c10=0e0;
	        
	        if( K >> 3 ){
	          size_t k8 = ( K >> 3 ); // Unrolling K
	          while( k8-- ){
	            a00 = *(A2 + 0 + 0*8 ); a10 = *(A2 + 1 + 0*8 ); a20 = *(A2 + 2 + 0*8 ); a30 = *(A2 + 3 + 0*8 ); // ymm0
	            a01 = *(A2 + 0 + 1*8 ); a11 = *(A2 + 1 + 1*8 ); a21 = *(A2 + 2 + 1*8 ); a31 = *(A2 + 3 + 1*8 ); // ymm1
	            b00 = *(B2 + 0 + 0*8 ); b10 = *(B2 + 1 + 0*8 ); b20 = *(B2 + 2 + 0*8 ); b30 = *(B2 + 3 + 0*8 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            a00 = *(A2 + 4 + 0*8 ); a10 = *(A2 + 5 + 0*8 ); a20 = *(A2 + 6 + 0*8 ); a30 = *(A2 + 7 + 0*8 ); // ymm0
	            a01 = *(A2 + 4 + 1*8 ); a11 = *(A2 + 5 + 1*8 ); a21 = *(A2 + 6 + 1*8 ); a31 = *(A2 + 7 + 1*8 ); // ymm1
	            b00 = *(B2 + 4 + 0*8 ); b10 = *(B2 + 5 + 0*8 ); b20 = *(B2 + 6 + 0*8 ); b30 = *(B2 + 7 + 0*8 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            A2+=16;
	            B2+=8;
	          }
	        }
	        if( K & 4 ){
	        //if( K >> 2 ){
	        //  size_t k4 = ( K >> 2 ); // Unrolling K
	        //  while( k4-- ){
	            a00 = *(A2 + 0 + 0*4 ); a10 = *(A2 + 1 + 0*4 ); a20 = *(A2 + 2 + 0*4 ); a30 = *(A2 + 3 + 0*4 ); // ymm0
	            a01 = *(A2 + 0 + 1*4 ); a11 = *(A2 + 1 + 1*4 ); a21 = *(A2 + 2 + 1*4 ); a31 = *(A2 + 3 + 1*4 ); // ymm1
	            b00 = *(B2 + 0 + 0*4 ); b10 = *(B2 + 1 + 0*4 ); b20 = *(B2 + 2 + 0*4 ); b30 = *(B2 + 3 + 0*4 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            c10 += a01 * b00; c10 += a11 * b10; c10 += a21 * b20; c10 += a31 * b30; // ymm12
	            A2+=8;
	            B2+=4;
	        //  }
	        }
	        if( K & 2 ){

	            a00 = *(A2 + 0 + 0*2 ); a10 = *(A2 + 1 + 0*2 );
	            a01 = *(A2 + 0 + 1*2 ); a11 = *(A2 + 1 + 1*2 );
	            b00 = *(B2 + 0 + 0*2 ); b10 = *(B2 + 1 + 0*2 );
	            c00 += a00 * b00; c00 += a10 * b10;
	            c10 += a01 * b00; c10 += a11 * b10;
	            A2+=4;
	            B2+=2;

	        }
	        if( K & 1 ){

	            a00 = *(A2 + 0 + 0*1 );
	            a01 = *(A2 + 0 + 1*1 );
	            b00 = *(B2 + 0 + 0*1 );
	            c00 += a00 * b00;
	            c10 += a01 * b00;
	            A2+=2;
	            B2+=1;

	        }
	        *(C+0+0*ldc) += alpha*c00;
	        *(C+1+0*ldc) += alpha*c10;
	        //A2 = A2 - K + 4*K;
	        B2 = B2 - 1*K;
	        C+=2;
	        //printf("pass through (n&1)&(m&2)\n");

	    }
	    if( M & 1 ){

	        c00=0e0;
	        
	        if( K >> 3 ){
	          size_t k8 = ( K >> 3 ); // Unrolling K
	          while( k8-- ){
	            a00 = *(A2 + 0 + 0*8 ); a10 = *(A2 + 1 + 0*8 ); a20 = *(A2 + 2 + 0*8 ); a30 = *(A2 + 3 + 0*8 ); // ymm0
	            b00 = *(B2 + 0 + 0*8 ); b10 = *(B2 + 1 + 0*8 ); b20 = *(B2 + 2 + 0*8 ); b30 = *(B2 + 3 + 0*8 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            a00 = *(A2 + 4 + 0*8 ); a10 = *(A2 + 5 + 0*8 ); a20 = *(A2 + 6 + 0*8 ); a30 = *(A2 + 7 + 0*8 ); // ymm0
	            b00 = *(B2 + 4 + 0*8 ); b10 = *(B2 + 5 + 0*8 ); b20 = *(B2 + 6 + 0*8 ); b30 = *(B2 + 7 + 0*8 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            A2+=8;
	            B2+=8;
	          }
	        }
	        if( K & 4 ){
	        //if( K >> 2 ){
	        //  size_t k4 = ( K >> 2 ); // Unrolling K
	        //  while( k4-- ){
	            a00 = *(A2 + 0 + 0*4 ); a10 = *(A2 + 1 + 0*4 ); a20 = *(A2 + 2 + 0*4 ); a30 = *(A2 + 3 + 0*4 ); // ymm0
	            b00 = *(B2 + 0 + 0*4 ); b10 = *(B2 + 1 + 0*4 ); b20 = *(B2 + 2 + 0*4 ); b30 = *(B2 + 3 + 0*4 ); // ymm4
	            c00 += a00 * b00; c00 += a10 * b10; c00 += a20 * b20; c00 += a30 * b30; // ymm12
	            A2+=4;
	            B2+=4;
	        //  }
	        }
	        if( K & 2 ){

	            a00 = *(A2 + 0 + 0*2 ); a10 = *(A2 + 1 + 0*2 );
	            b00 = *(B2 + 0 + 0*2 ); b10 = *(B2 + 1 + 0*2 );
	            c00 += a00 * b00; c00 += a10 * b10;
	            A2+=2;
	            B2+=2;

	        }
	        if( K & 1 ){

	            a00 = *(A2 + 0 + 0*1 );
	            b00 = *(B2 + 0 + 0*1 );
	            c00 += a00 * b00;
	            A2+=1;
	            B2+=1;

	        }
	        *(C+0+0*ldc) += alpha*c00;
	        //A2 = A2 - K + 4*K;
	        B2 = B2 - 1*K;
	        C+=1;


	    }
	    A2 = A2 - M*K;
	    B2 = B2 + 1*K;
	    C  = C - M + 1*ldc;
	        //printf("pass through (n&1)&(m&1)\n");

	}

	A2 = A2 + M*K;
	B2 = B2 - K*N;
	C  = C - ldc*N + M;
	// ---- Kernel


}

